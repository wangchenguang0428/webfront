<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>第 60 章 表访问方法接口定义</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="geqo-biblio.html" title="59.4. 进一步阅读" /><link rel="next" href="indexam.html" title="第 61 章 索引访问方法接口定义" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">第 60 章 表访问方法接口定义</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="geqo-biblio.html" title="59.4. 进一步阅读">上一页</a> </td><td width="10%" align="left"><a accesskey="u" href="internals.html" title="部分 VII. 内部">上一级</a></td><th width="60%" align="center">部分 VII. 内部</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 12.2 手册">起始页</a></td><td width="10%" align="right"> <a accesskey="n" href="indexam.html" title="第 61 章 索引访问方法接口定义">下一页</a></td></tr></table><hr></hr></div><div class="chapter" id="TABLEAM"><div class="titlepage"><div><div><h2 class="title">第 60 章 表访问方法接口定义</h2></div></div></div><a id="id-1.10.13.2" class="indexterm"></a><a id="id-1.10.13.3" class="indexterm"></a><p>
  本章阐述<span class="productname">PostgreSQL</span>核心系统与<em class="firstterm">表访问方法</em>间的接口，其管理表的存储。除这里指出的内容，核心系统对于这些访问方法知之甚少，因此可以通过编写附加代码来开发全新的访问方法类型。
 </p><p>
  每个表访问方法都有<a class="link" href="catalog-pg-am.html" title="51.3. pg_am"><code class="structname">pg_am</code></a>系统目录中的一行来描述。<code class="structname">pg_am</code>条目为表访问方法指定一个名字和<em class="firstterm">句柄函数</em>。这些条目可以用SQL命令<a class="xref" href="sql-create-access-method.html" title="CREATE ACCESS METHOD"><span class="refentrytitle">CREATE ACCESS METHOD</span></a>和<a class="xref" href="sql-drop-access-method.html" title="DROP ACCESS METHOD"><span class="refentrytitle">DROP ACCESS METHOD</span></a>来创建和删除。
 </p><p>
  表访问方法句柄函数必须声明成接受单个<code class="type">internal</code>类型的参数，并返回伪类型<code class="type">table_am_handler</code>。该参数是伪值，仅用于防止从SQL命令直接调用句柄函数。
  函数的结果必须是指向类型<code class="structname">TableAmRoutine</code>的结构的指针，其包含了核心代码所需要知道的所有内容，以利用表访问方法。返回值需具有服务器生命周期，通常是通过将其定义为一个全局范围的<code class="literal">static const</code>变量来实现。<code class="structname">TableAmRoutine</code>结构，也称为访问方法的<em class="firstterm">API结构</em>，定义使用回调的访问方法的行为。这些回调是普通C函数指针，在SQL级别并不可见或者可调用。所有回调及其行为在<code class="structname">TableAmRoutine</code>结构中定义（结构内部有定义回调需求的注释）。大多数回调有包装函数，从用户（而不是实现者）视点记录表访问方法。详细信息请参考<a class="ulink" href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/include/access/tableam.h;hb=HEAD" target="_top"> <code class="filename">src/include/access/tableam.h</code></a>文件。
 </p><p>
  为了实现访问方法，实现者通常要实现特定AM类型的元组表槽（见<a class="ulink" href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/include/executor/tuptable.h;hb=HEAD" target="_top"> <code class="filename">src/include/executor/tuptable.h</code></a>），允许访问方法之外的代码保存对AM元组的引用，并且能访问元组的列。
 </p><p>
  目前AM存储数据的实际方式完全没有限制。例如，可以使用postgres的共享缓冲区的缓存，但这并非必需的。如果使用它，使用<a class="xref" href="storage-page-layout.html" title="68.6. 数据库页面布局">第 68.6 节</a>中所述的<span class="productname">PostgreSQL</span>的标准页面布局可能很有意义。
 </p><p>
  当前表访问方法API的一个相当大的限制是，如果AM要支持修改和/或索引，每个元组都需要有由块号和项目号组成的元组标识符（<acronym class="acronym">TID</acronym>）（见<a class="xref" href="storage-page-layout.html" title="68.6. 数据库页面布局">第 68.6 节</a>）。<acronym class="acronym">TIDs</acronym>的子部分不一定具有与<code class="literal">堆</code>相同的含义，但如果需要位图扫描支持（可选），则块号需要提供局部性。
 </p><p>
  为安全起见，AM可使用postgres的<a class="link" href="wal.html" title="第 29 章 可靠性和预写式日志"><acronym class="acronym">WAL</acronym></a>或自定义实现。如果选用了<acronym class="acronym">WAL</acronym>，则可使用<a class="link" href="generic-wal.html" title="第 62 章 通用WAL 记录">通用WAL记录</a>或实现新型的<acronym class="acronym">WAL</acronym>记录。通用WAL记录较简单，但意味着WAL量更高。目前实现新型WAL记录需要修改核心代码（特别是<code class="filename">src/include/access/rmgrlist.h</code>）。
 </p><p>
  要以允许在单个事务中访问不同表访问方法的方式实现事务支持，可能需要与<code class="filename">src/backend/access/transam/xlog.c</code>中的机制紧密集成。
 </p><p>
  新的<code class="literal">表访问方法</code>的开发人员可参考<code class="filename">src/backend/access/heap/heapam_handler.c</code>中已有的<code class="literal">堆</code>实现代码，以了解其实现的细节。
 </p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="geqo-biblio.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="internals.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="indexam.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">59.4. 进一步阅读 </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始页</a></td><td width="40%" align="right" valign="top"> 第 61 章 索引访问方法接口定义</td></tr></table></div></body></html>