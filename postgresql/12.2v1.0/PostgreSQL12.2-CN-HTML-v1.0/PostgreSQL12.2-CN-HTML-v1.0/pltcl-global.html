<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>43.4. PL/Tcl 中的全局数据</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="pltcl-data.html" title="43.3. PL/Tcl 中的数据值" /><link rel="next" href="pltcl-dbaccess.html" title="43.5. 从 PL/Tcl 访问数据库" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">43.4. PL/Tcl 中的全局数据</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="pltcl-data.html" title="43.3. PL/Tcl 中的数据值">上一页</a> </td><td width="10%" align="left"><a accesskey="u" href="pltcl.html" title="第 43 章 PL/Tcl - Tcl 过程语言">上一级</a></td><th width="60%" align="center">第 43 章 PL/Tcl - Tcl 过程语言</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 12.2 手册">起始页</a></td><td width="10%" align="right"> <a accesskey="n" href="pltcl-dbaccess.html" title="43.5. 从 PL/Tcl 访问数据库">下一页</a></td></tr></table><hr></hr></div><div class="sect1" id="PLTCL-GLOBAL"><div class="titlepage"><div><div><h2 class="title" style="clear: both">43.4. PL/Tcl 中的全局数据</h2></div></div></div><a id="id-1.8.9.8.2" class="indexterm"></a><p>
     有时候需要在同一个函数的两次调用间保持某些全局数据或者在不同的函数之间共享全局数据。在 PL/Tcl 中这很容易做到，但是必须了解一些限制。
    </p><p>
     由于安全性原因，PL/Tcl 会为一个 SQL 角色建立一个单独的 Tcl 解释器来执行该角色调用的函数。这可以避免一个用户无意或者恶意地干涉另一个用户的 PL/Tcl 函数的行为。对任何<span class="quote">“<span class="quote">全局</span>”</span> Tcl 变量，每一个这样的解释器都有其自身的值。因此，当且仅当两个 PL/Tcl 函数由用一个 SQL 角色执行时，它们才能共享相同的全局变量。在使用单个会话执行多个 SQL 角色的代码（通过<code class="literal">SECURITY DEFINER</code>函数、使用<code class="command">SET ROLE</code>等）的应用中，需要采取显式的步骤以保证 PL/Tcl 函数能共享数据。要这样做，需要确保要通信的函数都属于同一个用户，并且把它们标记为<code class="literal">SECURITY DEFINER</code>。当然，要小心这样的函数被滥用。
    </p><p>
     在一个会话中使用的所有 PL/TclU 函数都在同一个 Tcl 解释器中执行，这当然与用于 PL/Tcl 函数的解释器不同。因此，在 PL/TclU 函数之间会自动地共享全局数据。这并不是一种安全性风险，因为所有的 PL/TclU 函数都在同样的信任级别上执行，即都以数据库超级用户的级别执行。
    </p><p>
     为了保护 PL/Tcl 函数不会无意间彼此干扰，通过<code class="function">upvar</code>命令可以建立一个对每个函数可用的全局数组。这个变量的全局名称是该函数的内部名称，并且本地名称为<code class="literal">GD</code>。推荐使用<code class="literal">GD</code>来保持一个函数的持久私有数据。只对你特别希望在多个函数之间共享的值使用常规的 Tcl 全局变量（注意<code class="literal">GD</code>数组只在一个特定的解释器中是全局的，因此它们不会绕过上文提到的安全性限制）。
    </p><p>
     下文的<code class="function">spi_execp</code>例子中有一个使用<code class="literal">GD</code>的例子。
    </p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="pltcl-data.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="pltcl.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="pltcl-dbaccess.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">43.3. PL/Tcl 中的数据值 </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始页</a></td><td width="40%" align="right" valign="top"> 43.5. 从 PL/Tcl 访问数据库</td></tr></table></div></body></html>