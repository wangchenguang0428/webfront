<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>18.5. 关闭服务器</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="kernel-resources.html" title="18.4. 管理内核资源" /><link rel="next" href="upgrading.html" title="18.6. 升级一个PostgreSQL集簇" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">18.5. 关闭服务器</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="kernel-resources.html" title="18.4. 管理内核资源">上一页</a> </td><td width="10%" align="left"><a accesskey="u" href="runtime.html" title="第 18 章 服务器设置和操作">上一级</a></td><th width="60%" align="center">第 18 章 服务器设置和操作</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 12.2 手册">起始页</a></td><td width="10%" align="right"> <a accesskey="n" href="upgrading.html" title="18.6. 升级一个PostgreSQL集簇">下一页</a></td></tr></table><hr></hr></div><div class="sect1" id="SERVER-SHUTDOWN"><div class="titlepage"><div><div><h2 class="title" style="clear: both">18.5. 关闭服务器</h2></div></div></div><a id="id-1.6.5.7.2" class="indexterm"></a><p>
   有几种关闭数据库服务器的方法。通过给<code class="command">postgres</code>进程发送不同的信号，你就可以控制关闭类型。

   </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="systemitem">SIGTERM</span><a id="id-1.6.5.7.3.2.1.1.2" class="indexterm"></a></span></dt><dd><p>
       这是<em class="firstterm">智能关闭</em>模式。在接收<span class="systemitem">SIGTERM</span>后， 服务器将不允许新连接，但是会让现有的会话正常结束它们的工作。仅当所有的会话终止后它才关闭。 如果服务器处在线备份模式，它将等待直到在线备份模式不再被激活。当在线备份模式被激活时， 仍然允许新的连接，但是只能是超级用户的连接（这一例外允许超级用户连接来终止在线备份模式）。 如果服务器在恢复时请求智能关闭，恢复和流复制只有在所有正常会话都终止后才停止。
      </p></dd><dt><span class="term"><span class="systemitem">SIGINT</span><a id="id-1.6.5.7.3.2.2.1.2" class="indexterm"></a></span></dt><dd><p>
       这是<em class="firstterm">快速关闭</em>模式。服务器不再允许新的连接，并向所有现有服务器进程发送<span class="systemitem">SIGTERM</span>，让它们中断当前事务并立刻退出。然后服务器等待所有服务器进程退出并最终关闭。 如果服务处于在线备份模式，备份模式将被终止并致使备份无用。
      </p></dd><dt><span class="term"><span class="systemitem">SIGQUIT</span><a id="id-1.6.5.7.3.2.3.1.2" class="indexterm"></a></span></dt><dd><p>
      这是<em class="firstterm">立即关闭</em>模式。服务器将给所有子进程发送
      <span class="systemitem">SIGQUIT</span>并且等待它们终止。如果有任何进程没有在 5 秒内终止，它们将被发送
      <span class="systemitem">SIGKILL</span>。主服务器进程将在所有子进程退出之后立刻退出，而无需做普通的数据库关闭处理。这将导致在下一次启动时（通过重放 WAL 日志）恢复。只在紧急
      时才推荐这种方式。
      </p></dd></dl></div><p>
  </p><p>
   <a class="xref" href="app-pg-ctl.html" title="pg_ctl"><span class="refentrytitle"><span class="application">pg_ctl</span></span></a>程序提供了一个发送这些信号关闭服务器的方便的接口。 另外，你在非 Windows 系统上可以用<code class="command">kill</code>直接发送这些信号。可以用<code class="command">ps</code>程序或者从数据目录的<code class="filename">postmaster.pid</code>文件中找到<code class="command">postgres</code>进程的<acronym class="acronym">PID</acronym>。例如，要做一次快速关闭：
</p><pre class="screen">
$ <strong class="userinput"><code>kill -INT `head -1 /usr/local/pgsql/data/postmaster.pid`</code></strong>
</pre><p>
  </p><div class="important"><h3 class="title">重要</h3><p>
    最好不要使用<span class="systemitem">SIGKILL</span>关闭服务器。这样做将会阻止服务器释放共享内存和信号量。 
    此外，使用<span class="systemitem">SIGKILL</span>杀掉<code class="command">postgres</code>进程时，<code class="command">postgres</code>不会有机会将信号传播到它的子进程，所以可能也必须手工杀掉单个的子进程。
   </p></div><p>
   要终止单个会话同时允许其他会话继续，使用<code class="function">pg_terminate_backend()</code>（参阅<a class="xref" href="functions-admin.html#FUNCTIONS-ADMIN-SIGNAL-TABLE" title="表 9.83. 服务器信号函数">表 9.83</a>） 或发送<span class="systemitem">SIGTERM</span>信号到该会话相关的子进程。
  </p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="kernel-resources.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="runtime.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="upgrading.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">18.4. 管理内核资源 </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始页</a></td><td width="40%" align="right" valign="top"> 18.6. 升级一个<span class="productname">PostgreSQL</span>集簇</td></tr></table></div></body></html>