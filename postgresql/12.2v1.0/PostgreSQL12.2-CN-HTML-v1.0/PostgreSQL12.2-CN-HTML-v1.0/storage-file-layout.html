<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>68.1. 数据库文件布局</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="storage.html" title="第 68 章 数据库物理存储" /><link rel="next" href="storage-toast.html" title="68.2. TOAST" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">68.1. 数据库文件布局</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="storage.html" title="第 68 章 数据库物理存储">上一页</a> </td><td width="10%" align="left"><a accesskey="u" href="storage.html" title="第 68 章 数据库物理存储">上一级</a></td><th width="60%" align="center">第 68 章 数据库物理存储</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 12.2 手册">起始页</a></td><td width="10%" align="right"> <a accesskey="n" href="storage-toast.html" title="68.2. TOAST">下一页</a></td></tr></table><hr></hr></div><div class="sect1" id="STORAGE-FILE-LAYOUT"><div class="titlepage"><div><div><h2 class="title" style="clear: both">68.1. 数据库文件布局</h2></div></div></div><p>
本节在文件和目录的层次上描述存储格式。
</p><p>
在传统上，数据库集簇所使用的配置和数据文件都被一起存储在集簇的数据目录里， 通常用<code class="varname">PGDATA</code>来引用（用的是可以定义它的环境变量的名字）。<code class="varname">PGDATA</code>的一个常见位置是<code class="filename">/var/lib/pgsql/data</code>。由不同数据库实例所管理的多个集簇可以在同一台机器上共存。
</p><p>
<code class="varname">PGDATA</code>目录包含几个子目录以及一些控制文件， 如<a class="xref" href="storage-file-layout.html#PGDATA-CONTENTS-TABLE" title="表 68.1. PGDATA的内容">表 68.1</a>所示。除了这些必要的东西之外，集簇的配置文件<code class="filename">postgresql.conf</code>、<code class="filename">pg_hba.conf</code>和<code class="filename">pg_ident.conf</code>通常都存储在<code class="varname">PGDATA</code>中，不过可以把它们放在别的地方。
</p><div class="table" id="PGDATA-CONTENTS-TABLE"><p class="title"><strong>表 68.1. <code class="varname">PGDATA</code>的内容</strong></p><div class="table-contents"><table class="table" summary="PGDATA的内容" border="1"><colgroup><col /><col /></colgroup><thead><tr><th>
项
</th><th>描述</th></tr></thead><tbody><tr><td><code class="filename">PG_VERSION</code></td><td>一个包含<span class="productname">PostgreSQL</span>主版本号的文件</td></tr><tr><td><code class="filename">base</code></td><td>包含每个数据库对应的子目录的子目录</td></tr><tr><td><code class="filename">current_logfiles</code></td><td>记录当前被日志收集器写入的日志文件的文件</td></tr><tr><td><code class="filename">global</code></td><td>包含集簇范围的表的子目录，比如<code class="structname">pg_database</code></td></tr><tr><td><code class="filename">pg_commit_ts</code></td><td>包含事务提交时间戳数据的子目录</td></tr><tr><td><code class="filename">pg_dynshmem</code></td><td>包含被动态共享内存子系统所使用的文件的子目录</td></tr><tr><td><code class="filename">pg_logical</code></td><td>包含用于逻辑复制的状态数据的子目录</td></tr><tr><td><code class="filename">pg_multixact</code></td><td>包含多事务（multi-transaction）状态数据的子目录（用于共享的行锁）</td></tr><tr><td><code class="filename">pg_notify</code></td><td>包含LISTEN/NOTIFY状态数据的子目录</td></tr><tr><td><code class="filename">pg_replslot</code></td><td>包含复制槽数据的子目录</td></tr><tr><td><code class="filename">pg_serial</code></td><td>包含已提交的可序列化事务信息的子目录</td></tr><tr><td><code class="filename">pg_snapshots</code></td><td>包含导出的快照的子目录</td></tr><tr><td><code class="filename">pg_stat</code></td><td>包含用于统计子系统的永久文件的子目录</td></tr><tr><td><code class="filename">pg_stat_tmp</code></td><td>包含用于统计信息子系统的临时文件的子目录</td></tr><tr><td><code class="filename">pg_subtrans</code></td><td>包含子事务状态数据的子目录</td></tr><tr><td><code class="filename">pg_tblspc</code></td><td>包含指向表空间的符号链接的子目录</td></tr><tr><td><code class="filename">pg_twophase</code></td><td>包含用于预备事务状态文件的子目录</td></tr><tr><td><code class="filename">pg_wal</code></td><td>包含 WAL （预写日志）文件的子目录</td></tr><tr><td><code class="filename">pg_xact</code></td><td>包含事务提交状态数据的子目录</td></tr><tr><td><code class="filename">postgresql.auto.conf</code></td><td>一个用于存储由<code class="command">ALTER SYSTEM</code>
 设置的配置参数的文件</td></tr><tr><td><code class="filename">postmaster.opts</code></td><td>一个记录服务器最后一次启动时使用的命令行参数的文件</td></tr><tr><td><code class="filename">postmaster.pid</code></td><td>一个锁文件，记录着当前的 postmaster 进程ID（PID）、集簇数据目录路径、postmaster启动时间戳、端口号、Unix域套接字目录路径（Windows上为空）、第一个可用的listen_address（IP地址或者<code class="literal">*</code>，或者为空表示不在TCP上监听）以及共享内存段ID（服务器关闭后该文件不存在）</td></tr></tbody></table></div></div><br class="table-break" /><p>
对于集簇里的每个数据库，在<code class="varname">PGDATA</code><code class="filename">/base</code>里都有一个子目录对应， 子目录的名字为该数据库在 <code class="structname">pg_database</code>里的 OID。这个子目录是该数据库文件的缺省位置；特别值得一提的是，该数据库的系统目录存储在此。
</p><p>
 注意后续章节描述了内置的<code class="literal">heap</code> <a class="link" href="tableam.html" title="第 60 章 表访问方法接口定义">表访问方法</a>的行为，和内置 <a class="link" href="indexam.html" title="第 61 章 索引访问方法接口定义">索引访问方法</a>。
 由于<span class="productname">PostgreSQL</span>的可扩展特性，其他访问方法的工作方式可能不同。
</p><p>
每个表和索引都存储在独立的文件里。对于普通关系，这些文件以表或索引的<em class="firstterm">filenode</em>号命名，它可以在<code class="structname">pg_class</code>.<code class="structfield">relfilenode</code>中找到。但是对于临时关系，文件名的形式为<code class="literal">t<em class="replaceable"><code>BBB</code></em>_<em class="replaceable"><code>FFF</code></em></code>，其中<em class="replaceable"><code>BBB</code></em>是创建该文件的后台的后台ID，<em class="replaceable"><code>FFF</code></em>是文件节点号。在每种情况下，在主文件（a/k/a 主分支）之外，每个表和索引有一个<em class="firstterm">空闲空间映射</em>（见<a class="xref" href="storage-fsm.html" title="68.3. 空闲空间映射">第 68.3 节</a>），它存储关系中可用空闲空间的信息。空闲空间映射存储在一个文件中，该文件以节点号加上后缀<code class="literal">_fsm</code>命名。表还有一个<em class="firstterm">可见性映射</em>，存储在一个后缀为<code class="literal">_vm</code>的分支中，它用于跟踪哪些页面已知含有非死亡元组。可见性映射将在<a class="xref" href="storage-vm.html" title="68.4. 可见性映射">第 68.4 节</a>中进一步描述。不被日志记录的表和索引还有第三个分支，即初始化分支，它存储在后缀为<code class="literal">_init</code>的分支中（见<a class="xref" href="storage-init.html" title="68.5. 初始化分支">第 68.5 节</a>）。
</p><div class="caution"><h3 class="title">小心</h3><p>
请注意，虽然一个表的文件节点通常和它的 OID 相匹配，但实际上并<span class="emphasis"><em>不</em></span>必须如此； 有些操作，比如 <code class="command">TRUNCATE</code>、<code class="command">REINDEX</code>、<code class="command">CLUSTER</code>以及某些形式的<code class="command">ALTER TABLE</code>，都可以改变文件节点而同时保留 OID。我们不应该假设文件节点和表 OID 相同。此外，对于包含<code class="structname">pg_class</code>本身在内的特定系统目录，其<code class="structname">pg_class</code>.<code class="structfield">relfilenode</code>包含0。这些目录的实际文件节点号被存储在一个低层数据结构中，并且可以使用<code class="function">pg_relation_filenode()</code>函数获取。
</p></div><p>
在表或者索引超过 1GB 之后，它就被划分成1G大小的<em class="firstterm">段</em>。 第一个段的文件名和文件节点相同；随后的段被命名为 filenode.1、filenode.2等等。这样的安排避免了在某些有文件大小限制的平台上的问题（实际上，1GB只是默认的段尺寸。段尺寸可以在编译<span class="productname">PostgreSQL</span>时使用配置选项<code class="option">--with-segsize</code>进行调整）。原则上，空闲空间映射和可见性映射分支也可以要求多个段，但实际上这很少发生。
</p><p>
如果一个表的列中可能存储相当大的项，那么该表就会有个与之相关联的<em class="firstterm">TOAST</em>表， 它用于存储无法保留在在表行中的域值的线外存储。如果表有<em class="firstterm">TOAST</em>表，该表的<code class="structname">pg_class</code>.<code class="structfield">reltoastrelid</code>链接到它的<acronym class="acronym">TOAST</acronym>表。 参阅<a class="xref" href="storage-toast.html" title="68.2. TOAST">第 68.2 节</a>获取更多信息。
</p><p>
表和索引的内容在<a class="xref" href="storage-page-layout.html" title="68.6. 数据库页面布局">第 68.6 节</a>中进一步讨论。
</p><p>
表空间的情况更复杂些。每个用户定义的表空间都在<code class="varname">PGDATA</code><code class="filename">/pg_tblspc</code>目录里面有一个符号连接，它指向物理的表空间目录（就是在<code class="command">CREATE TABLESPACE</code>命令里指定的那个目录）。这个符号连接是用表空间的 OID 命名的。在物理表空间目录中有一个名称取决于<span class="productname">PostgreSQL</span>服务器版本的子目录，例如<code class="literal">PG_9.0_201008051</code>（使用该子目录的原因是后续版本的数据库可以使用<code class="command">CREATE TABLESPACE</code>指定相同的目录位置而不会造成冲突）。在这个版本相关的子目录中，为每个在这个表空间里有元素的数据库都有一个子目录， 以数据库的OID命名。该目录里的表和索引遵循文件节点命名模式。<code class="literal">pg_default</code>不需要通过<code class="filename">pg_tblspc</code>来访问，而是对应于<code class="varname">PGDATA</code><code class="filename">/base</code>。类似地，<code class="literal">pg_global</code>表空间也不通过<code class="filename">pg_tblspc</code>访问，而是对应于<code class="varname">PGDATA</code><code class="filename">/global</code>。
</p><p>
<code class="function">pg_relation_filepath()</code>函数显示任何关系的完整路径（相对于<code class="varname">PGDATA</code>）。它可以作为记住上面这么多规则的替代方法。但是记住该函数只给出关系的主分支的第一个段的名称 — 你也许需要追加一个段号和/或<code class="literal">_fsm</code>、<code class="literal">_vm</code>或者<code class="literal">_init</code>来找到与该关系相关的所有文件。
</p><p>
临时文件（用于如排序不能放在内存中的数据等操作）被创建在<code class="varname">PGDATA</code><code class="filename">/base/pgsql_tmp</code>中，如果临时文件被指定在一个非<code class="literal">pg_default</code>表空间中则它们会被创建在该表空间的<code class="filename">pgsql_tmp</code>子目录中。临时文件的名称的形式为<code class="filename">pgsql_tmp<em class="replaceable"><code>PPP</code></em>.<em class="replaceable"><code>NNN</code></em></code>，其中<em class="replaceable"><code>PPP</code></em>是其所属后端的PID，而<em class="replaceable"><code>NNN</code></em>用于区别该后端的不同临时文件。
</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="storage.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="storage.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="storage-toast.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">第 68 章 数据库物理存储 </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始页</a></td><td width="40%" align="right" valign="top"> 68.2. TOAST</td></tr></table></div></body></html>