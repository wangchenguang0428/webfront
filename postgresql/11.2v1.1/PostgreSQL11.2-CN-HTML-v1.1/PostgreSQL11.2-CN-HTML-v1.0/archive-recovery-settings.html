<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>27.1. 归档恢复设置</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="recovery-config.html" title="第 27 章 恢复配置" /><link rel="next" href="recovery-target-settings.html" title="27.2. 恢复目标设置" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">27.1. 归档恢复设置</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="recovery-config.html" title="第 27 章 恢复配置">上一页</a> </td><td width="10%" align="left"><a accesskey="u" href="recovery-config.html" title="第 27 章 恢复配置">上一级</a></td><th width="60%" align="center">第 27 章 恢复配置</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 11.2 手册">起始页</a></td><td width="10%" align="right"> <a accesskey="n" href="recovery-target-settings.html" title="27.2. 恢复目标设置">下一页</a></td></tr></table><hr></hr></div><div class="sect1" id="ARCHIVE-RECOVERY-SETTINGS"><div class="titlepage"><div><div><h2 class="title" style="clear: both">27.1. 归档恢复设置</h2></div></div></div><div class="variablelist"><dl class="variablelist"><dt id="RESTORE-COMMAND"><span class="term"><code class="varname">restore_command</code> (<code class="type">string</code>)
      <a id="id-1.6.14.6.2.1.1.3" class="indexterm"></a>
      </span></dt><dd><p>
        用于获取 WAL 文件系列的一个已归档段的本地 shell 命令。这个参数是归档恢复所必需的，但是对于流复制是可选的。在该字符串中的任何<code class="literal">%f</code>会被替换为从归档中获得的文件的名字，并且任何<code class="literal">%p</code>会被在服务器上的复制目标路径名替换（该路径名是相对于当前工作目录的，即集簇的数据目录）。任何<code class="literal">%r</code>会被包含上一个可用重启点的文件的名字所替换。在那些必须被保留用于使得一次恢复变成可重启的文件中，这个文件是其中最早的一个，因此这个信息可以被用来把归档截断为支持从当前恢复重启所需的最小值。<code class="literal">%r</code>通常只被温备配置（见<a class="xref" href="warm-standby.html" title="26.2. 日志传送后备服务器">第 26.2 节</a>）所使用。要嵌入一个真正的<code class="literal">%</code>字符，需要写成<code class="literal">%%</code>。
       </p><p>
        很重要的一点是，该命令只有在成功时才返回一个为零的退出状态。该命令<span class="emphasis"><em>将</em></span>会被询问不存在于归档中的文件名，当这样被询问时它必须返回非零。例子：
</p><pre class="programlisting">
restore_command = 'cp /mnt/server/archivedir/%f "%p"'
restore_command = 'copy "C:\\server\\archivedir\\%f" "%p"'  # Windows
</pre><p>
       一个例外是如果该命令被一个信号（不是<span class="systemitem">SIGTERM</span>，它是数据库服务器关闭的一部分）或者一个 shell 错误（例如命令未找到）终止，则恢复将会中止并且服务器将不会启动。
       </p></dd><dt id="ARCHIVE-CLEANUP-COMMAND"><span class="term"><code class="varname">archive_cleanup_command</code> (<code class="type">string</code>)
      <a id="id-1.6.14.6.2.2.1.3" class="indexterm"></a>
      </span></dt><dd><p>
        这个可选参数指定了一个 shell 命令，它将在每一个重启点被执行。<code class="varname">archive_cleanup_command</code>的目的是提供一种清除不再被后备服务器需要的旧的已归档 WAL 文件的机制。任何<code class="literal">%r</code>会被替换为包含最后一个可用重启点的文件的名称。那是使一次恢复变成可重启的所必须被<span class="emphasis"><em>保留</em></span>的最早的文件，并且因此比<code class="literal">%r</code>更早的所有文件可以被安全地移除。这个信息可以被用来把归档截断为支持从当前恢复重启所需的最小值。对于单一后备配置，<a class="xref" href="pgarchivecleanup.html" title="pg_archivecleanup"><span class="refentrytitle"><span class="application">pg_archivecleanup</span></span></a>模块常常被用在<code class="varname">archive_cleanup_command</code>中，例如：
</p><pre class="programlisting">archive_cleanup_command = 'pg_archivecleanup /mnt/server/archivedir %r'</pre><p>
        但是注意，如果多个后备服务器正在从同一个归档目录中恢复，你将需要保证只有当任意服务器都不再需要 WAL 文件时才会删除它们。<code class="varname">archive_cleanup_command</code>通常被用于一种温后备配置（见<a class="xref" href="warm-standby.html" title="26.2. 日志传送后备服务器">第 26.2 节</a>）中。要在该命令中嵌入一个真正的<code class="literal">%</code>字符，需要写成<code class="literal">%%</code>。
       </p><p>
        如果该命令返回一个非零退出状态，则将会写出一个警告日志消息。一个例外是如果该命令被一个信号或者一个 shell 错误（例如命令未找到）终止，则会抛出一个致命错误。
       </p></dd><dt id="RECOVERY-END-COMMAND"><span class="term"><code class="varname">recovery_end_command</code> (<code class="type">string</code>)
      <a id="id-1.6.14.6.2.3.1.3" class="indexterm"></a>
      </span></dt><dd><p>
        这个参数指定了一个将只在恢复末尾被执行一次的 shell 命令。这个参数是可选的。<code class="varname">recovery_end_command</code>的目的是为复制或恢复之后的清除提供一种机制。与<a class="xref" href="archive-recovery-settings.html#ARCHIVE-CLEANUP-COMMAND">archive_cleanup_command</a>中相似，任何<code class="literal">%r</code>会被替换为包含最后一个可用重启点的文件的名称。
       </p><p>
        如果该命令返回一个非零退出状态，则一个警告日志消息将被写出并且不管怎样该数据库将继续启动。一个例外是如果该命令被一个信号或者 shell 错误（例如命令未找到）中止，该数据库将不会继续启动。
       </p></dd></dl></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="recovery-config.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="recovery-config.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="recovery-target-settings.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">第 27 章 恢复配置 </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始页</a></td><td width="40%" align="right" valign="top"> 27.2. 恢复目标设置</td></tr></table></div></body></html>