<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>24.3. 日志文件维护</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="routine-reindex.html" title="24.2. 日常重建索引" /><link rel="next" href="backup.html" title="第 25 章 备份和恢复" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">24.3. 日志文件维护</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="routine-reindex.html" title="24.2. 日常重建索引">上一页</a> </td><td width="10%" align="left"><a accesskey="u" href="maintenance.html" title="第 24 章 日常数据库维护工作">上一级</a></td><th width="60%" align="center">第 24 章 日常数据库维护工作</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 11.2 手册">起始页</a></td><td width="10%" align="right"> <a accesskey="n" href="backup.html" title="第 25 章 备份和恢复">下一页</a></td></tr></table><hr></hr></div><div class="sect1" id="LOGFILE-MAINTENANCE"><div class="titlepage"><div><div><h2 class="title" style="clear: both">24.3. 日志文件维护</h2></div></div></div><a id="id-1.6.11.12.2" class="indexterm"></a><p>
   把数据库服务器的日志输出保存在一个地方是个好主意， 而不是仅仅通过<code class="filename">/dev/null</code>丢弃它们。 在进行问题诊断的时候，日志输出是非常宝贵的。不过，日志输出可能很庞大（特别是在比较高的调试级别上）， 因此你不会希望无休止地保存它们。你需要<span class="emphasis"><em>轮转</em></span>日志文件， 这样在一段合理的时间后会开始新的日志文件并且移除旧的。
  </p><p>
   如果你简单地把<code class="command">postgres</code>的<span class="systemitem">stderr</span>定向到一个文件中，你会得到日志输出， 但是截断该日志文件的唯一方法是停止并重起服务器。这样做对于开发环境中使用的<span class="productname">PostgreSQL</span>可能是可接受的，但是你肯定不想在生产环境上这么干。
  </p><p>
   一个更好的办法是把服务器的<span class="systemitem">stderr</span>输出发送到某种日志轮转程序里。 我们有一个内建的日志轮转程序，你可以通过在 <code class="filename">postgresql.conf</code>里设置配置参数<code class="varname">logging_collector</code>为<code class="literal">true</code>的办法启用它。该程序的控制参数在 <a class="xref" href="runtime-config-logging.html#RUNTIME-CONFIG-LOGGING-WHERE" title="19.8.1. 在哪里做日志">第 19.8.1 节</a>里描述。你也可以使用这种方法把日志数据捕捉成机器可读的<acronym class="acronym">CSV</acronym>（逗号分隔值）格式。
  </p><p>
   另外，如果在你已经使用的其他服务器软件中有一个外部日志轮转程序，你可能更喜欢使用它。 比如，包含在<span class="productname">Apache</span>发布里的<span class="application">rotatelogs</span>工具就可以用于<span class="productname">PostgreSQL</span>。 要这么做，只需要把服务器的<span class="systemitem">stderr</span>用管道重定向到要用的程序。 如果你用<code class="command">pg_ctl</code>启动服务器，那么<span class="systemitem">stderr</span>已经重定向到<span class="systemitem">stdout</span>， 因此你只需要一个管道命令，比如：

</p><pre class="programlisting">
pg_ctl start | rotatelogs /var/log/pgsql_log 86400
</pre><p>
  </p><p>
   另外一种生产级的管理日志输出的方法就是把它们发送给<span class="application">syslog</span>，让<span class="application">syslog</span>处理文件轮转。 要利用这个工具，我们需要设置<code class="filename">postgresql.conf</code>里的<code class="varname">log_destination</code>配置参数设置为<code class="literal">syslog</code>（记录<code class="literal">syslog</code>日志）。然后在你想强迫<span class="application">syslog</span>守护进程开始写入一个新日志文件的时候， 你就可以发送一个 <code class="literal">SIGHUP</code>信号给它。 如果你想自动进行日志轮转，可以配置<span class="application">logrotate</span>程序处理 来自<span class="application">syslog</span>的日志文件。
  </p><p>
   不过，在很多系统上，<span class="application">syslog</span>不是非常可靠，特别是在面对大量日志消息的情况下； 它可能在你最需要那些消息的时候截断或者丢弃它们。另外，在<span class="productname">Linux</span>，<span class="application">syslog</span>会把每个消息刷写到磁盘上， 这将导致很差的性能（你可以在<span class="application">syslog</span>配置文件里面的文件名开头使用一个<span class="quote">“<span class="quote"><code class="literal">-</code></span>”</span>来禁用这种行为）。
  </p><p>
   请注意上面描述的所有解决方案关注的是在可配置的间隔上开始一个新的日志文件， 但它们并没有处理对旧的、不再需要的日志文件的删除。你可能还需要设置一个批处理任务来定期地删除旧日志文件。 另一种可能的方法是配置日志轮转程序，让它循环地覆盖旧的日志文件。
  </p><p>
   <a class="ulink" href="https://pgbadger.darold.net/" target="_top"><span class="productname">pgBadger</span></a>是一个外部项目，它可以进行日志文件的深度分析。
   <a class="ulink" href="https://bucardo.org/check_postgres/" target="_top"><span class="productname">check_postgres</span></a>可在重要消息出现在日志文件中时向Nagios提供警告，也可以探测很多其他的特别情况。
  </p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="routine-reindex.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="maintenance.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="backup.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">24.2. 日常重建索引 </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始页</a></td><td width="40%" align="right" valign="top"> 第 25 章 备份和恢复</td></tr></table></div></body></html>