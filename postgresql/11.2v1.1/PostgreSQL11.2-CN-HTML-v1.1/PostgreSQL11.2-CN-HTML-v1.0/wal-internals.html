<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>30.5. WAL内部</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="wal-configuration.html" title="30.4. WAL配置" /><link rel="next" href="logical-replication.html" title="第 31 章 逻辑复制" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">30.5. WAL内部</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="wal-configuration.html" title="30.4. WAL配置">上一页</a> </td><td width="10%" align="left"><a accesskey="u" href="wal.html" title="第 30 章 可靠性和预写式日志">上一级</a></td><th width="60%" align="center">第 30 章 可靠性和预写式日志</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 11.2 手册">起始页</a></td><td width="10%" align="right"> <a accesskey="n" href="logical-replication.html" title="第 31 章 逻辑复制">下一页</a></td></tr></table><hr></hr></div><div class="sect1" id="WAL-INTERNALS"><div class="titlepage"><div><div><h2 class="title" style="clear: both">30.5. WAL内部</h2></div></div></div><a id="id-1.6.17.7.2" class="indexterm"></a><p>
   <acronym class="acronym">WAL</acronym>是自动被启用的。除了确保满足<acronym class="acronym">WAL</acronym>日志存放所需要的磁盘空间以及一些必要的调优外（参阅<a class="xref" href="wal-configuration.html" title="30.4. WAL配置">第 30.4 节</a>），管理员无需执行任何操作。
  </p><p>
   当每个新记录被写入时，<acronym class="acronym">WAL</acronym>记录被追加到<acronym class="acronym">WAL</acronym>日志中。
   插入位置由日志序列号（<acronym class="acronym">LSN</acronym>）描述，该日志序列号是日志中的字节偏移量，
   随每个新记录单调递增。<acronym class="acronym">LSN</acronym>值作为数据类型
   <a class="link" href="datatype-pg-lsn.html" title="8.20. pg_lsn 类型"><code class="type">pg_lsn</code></a>返回。
   值可以进行比较以计算分离它们的<acronym class="acronym">WAL</acronym>数据量，因此它们用于衡量复制和恢复的进度。
  </p><p>
   <acronym class="acronym">WAL</acronym>日志被存放在数据目录的<code class="filename">pg_wal</code>目录里，它是作为一个文件段的集合存储的，通常每个段16MB大小（不过这个大小可以通过initdb配置选项<code class="option">--with-wal-segsize</code>来修改）。每个段分割成多个页，通常每个页为8K（该尺寸可以通过<code class="option">--with-wal-blocksize</code>配置选项来修改）。日志记录头部在<code class="filename">access/xlogrecord.h</code>里描述；日志内容取决于它记录的事件类型。段文件的名字是不断增长的数字，从<code class="filename">000000010000000000000000</code>开始。目前这些数字不能回卷，不过要把所有可用的数字都用光也需要非常非常长的时间。
  </p><p>
   日志被放置在和主数据库文件不同的另外一个磁盘上会比较好。你可以通过把<code class="filename">pg_wal</code>目录移动到另外一个位置（当然在此期间服务器应当被关闭），然后在原来的位置上创建一个指向新位置的符号链接来实现重定位日志。
  </p><p>
   <acronym class="acronym">WAL</acronym>的目的是确保在数据库记录被修改之前先写了日志，但是这可能会被那些谎称向内核写成功的<a id="id-1.6.17.7.7.2" class="indexterm"></a>破坏， 这时候它们实际上只是缓冲了数据而并未把数据存储到磁盘上。 这种情况下的电源失效仍然可能导致不可恢复的数据崩溃。 管理员应该确保保存<span class="productname">PostgreSQL</span>的<acronym class="acronym">WAL</acronym>日志文件的磁盘不会做这种谎报（参见<a class="xref" href="wal-reliability.html" title="30.1. 可靠性">第 30.1 节</a>）。
  </p><p>
   在完成一个检查点并且刷写了日志文件之后，检查点的位置被保存在文件<code class="filename">pg_control</code>里。因此在恢复的开始， 服务器首先读取<code class="filename">pg_control</code>，然后读取检查点记录； 接着它通过从检查点记录里标识的日志位置开始向前扫描执行 REDO操作。 因为数据页的所有内容都保存在检查点之后的第一个页面修改的日志里（假设<a class="xref" href="runtime-config-wal.html#GUC-FULL-PAGE-WRITES">full_page_writes</a>没有被禁用）， 所以自检查点以来的所有变化的页都将被恢复到一个一致的状态。
  </p><p>
   为了处理<code class="filename">pg_control</code>被损坏的情况， 我们应该支持对于现有日志段反向扫描的功能 — 从最新到最老 — 这样才能找到最后的检查点。但这些目前还没有被实现。<code class="filename">pg_control</code>很小（比一个磁盘页小），因此它不会出现页断裂问题， 并且到目前为止还没有发现仅仅由于无法读取<code class="filename">pg_control</code>本身导致数据库失败的报告。 因此，尽管这在理论上是一个薄弱环节，但是<code class="filename">pg_control</code>看起来似乎并不是实际会发生的问题。
  </p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="wal-configuration.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="wal.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="logical-replication.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">30.4. <acronym class="acronym">WAL</acronym>配置 </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始页</a></td><td width="40%" align="right" valign="top"> 第 31 章 逻辑复制</td></tr></table></div></body></html>