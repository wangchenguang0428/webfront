<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>34.5. 一行一行地检索查询结果</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="libpq-async.html" title="34.4. 异步命令处理" /><link rel="next" href="libpq-cancel.html" title="34.6. 取消进行中的查询" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">34.5. 一行一行地检索查询结果</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="libpq-async.html" title="34.4. 异步命令处理">上一页</a> </td><td width="10%" align="left"><a accesskey="u" href="libpq.html" title="第 34 章 libpq - C 库">上一级</a></td><th width="60%" align="center">第 34 章 <span xmlns="http://www.w3.org/1999/xhtml" class="application">libpq</span> - C 库</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 11.2 手册">起始页</a></td><td width="10%" align="right"> <a accesskey="n" href="libpq-cancel.html" title="34.6. 取消进行中的查询">下一页</a></td></tr></table><hr></hr></div><div class="sect1" id="LIBPQ-SINGLE-ROW-MODE"><div class="titlepage"><div><div><h2 class="title" style="clear: both">34.5. 一行一行地检索查询结果</h2></div></div></div><a id="id-1.7.3.12.2" class="indexterm"></a><p>
   通常，<span class="application">libpq</span>会收集一个 SQL 命令的整个结果并且把它作为单个<code class="structname">PGresult</code>返回给应用。这对于返回大量行的命令是行不通的。对于这类情况，应用可以使用<code class="function">PQsendQuery</code>和<code class="function">PQgetResult</code>的<em class="firstterm">单行模式</em>。在这种模式中，结果行以一次一行的方式被返回给应用。
  </p><p>
   要进入到单行模式，在一次成功的<code class="function">PQsendQuery</code>（或者其他兄弟函数）调用后立即调用<code class="function">PQsetSingleRowMode</code>。这种模式选择只对当前正在执行的查询有效。然后反复调用<code class="function">PQgetResult</code>，直到它返回空，如<a class="xref" href="libpq-async.html" title="34.4. 异步命令处理">第 34.4 节</a>中所示。如果该查询返回行，它们会作为单个的<code class="structname">PGresult</code>对象返回，它们看起来都像普通的查询结果，只不过其状态代码是<code class="literal">PGRES_SINGLE_TUPLE</code>而非<code class="literal">PGRES_TUPLES_OK</code>。在最后一行之后或者紧接着该查询返回零行之后，一个状态为<code class="literal">PGRES_TUPLES_OK</code>的零行对象会被返回，这就是代表不会有更多行的信号（但是注意仍然有必要继续调用<code class="function">PQgetResult</code>直到它返回空）。所有这些<code class="structname">PGresult</code>对象将包含相同的行描述数据（列名、类型等等），这些数据和通常一个查询的<code class="structname">PGresult</code>对象的相同。每一个对象都应该按常规用<code class="function">PQclear</code>释放。
  </p><p>
   </p><div class="variablelist"><dl class="variablelist"><dt id="LIBPQ-PQSETSINGLEROWMODE"><span class="term">
      <code class="function">PQsetSingleRowMode</code>
      <a id="id-1.7.3.12.5.1.1.1.2" class="indexterm"></a>
     </span></dt><dd><p>
       为当前正在执行的查询选择单行模式。

</p><pre class="synopsis">
int PQsetSingleRowMode(PGconn *conn);
</pre><p>
      </p><p>
       这个函数只能在调用<code class="function">PQsendQuery</code>或一个其兄弟函数之后立刻调用，并且要在任何连接上的其他操作之前调用，例如<code class="function">PQconsumeInput</code>或<code class="function">PQgetResult</code>。如果在正确的时间被调用，该函数会为当前查询激活单行模式并且返回 1。否则模式会保持不变并且该函数返回 0。在任何情况下，当前查询结束之后模式都会恢复到正常。
      </p></dd></dl></div><p>
  </p><div class="caution"><h3 class="title">小心</h3><p>
    在处理一个查询时，服务器可能返回一些行并且接着遇到一个错误导致查询被中断。通常，<span class="application">libpq</span>会丢弃掉这样的行并且至报告错误。但是在单行模式中，那些行（错误之前返回的行）已经被返回给应用。因此，应用将看到一些<code class="literal">PGRES_SINGLE_TUPLE</code> <code class="structname">PGresult</code>对象并且然后看到一个<code class="literal">PGRES_FATAL_ERROR</code>对象。为了得到正确的事务行为，如果查询最终失败，应用必须被设计为丢弃或者撤销使用之前处理的行完成的事情。
   </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="libpq-async.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="libpq.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="libpq-cancel.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">34.4. 异步命令处理 </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始页</a></td><td width="40%" align="right" valign="top"> 34.6. 取消进行中的查询</td></tr></table></div></body></html>