<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>69.1. 系统目录声明规则</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="bki.html" title="第 69 章 系统目录声明和初始内容" /><link rel="next" href="system-catalog-initial-data.html" title="69.2. 系统目录初始数据" /></head><body><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="5" align="center">69.1. 系统目录声明规则</th></tr><tr><td width="10%" align="left"><a accesskey="p" href="bki.html" title="第 69 章 系统目录声明和初始内容">上一页</a> </td><td width="10%" align="left"><a accesskey="u" href="bki.html" title="第 69 章 系统目录声明和初始内容">上一级</a></td><th width="60%" align="center">第 69 章 系统目录声明和初始内容</th><td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 11.2 手册">起始页</a></td><td width="10%" align="right"> <a accesskey="n" href="system-catalog-initial-data.html" title="69.2. 系统目录初始数据">下一页</a></td></tr></table><hr></hr></div><div class="sect1" id="SYSTEM-CATALOG-DECLARATIONS"><div class="titlepage"><div><div><h2 class="title" style="clear: both">69.1. 系统目录声明规则</h2></div></div></div><p>
   一个目录头文件的关键部分是一个C的结构定义，它描述该目录中每一行的布局。这个结构开始于一个<code class="literal">CATALOG</code>宏，它对于C编译器而言只不过是<code class="literal">typedef struct FormData_<em class="replaceable"><code>catalogname</code></em></code>的一个简写。该结构中的每一个域会导致出现一个目录列。域可以用<code class="filename">genbki.h</code>中描述的BKI属性宏进行标注，例如可以为域定义默认值或者把域标记为可以为空或者不能为空。<code class="literal">CATALOG</code>行也可以用<code class="filename">genbki.h</code>中描述的一些其他BKI属性宏标注，用于定义该目录整体的其他属性，例如是否有OID（默认是有的）。
  </p><p>
   系统目录缓冲代码（以及大部分目录功能代码）假定所有的系统目录元组的定长部分是实际的存在形式，因为它会把这个C结构声明映射到定长部分之上。因此，所有变长域和可以为空的域必须被放置在最后，并且不能够以结构的域的方式访问。例如，如果尝试设置<code class="structname">pg_type</code>.<code class="structfield">typrelid</code>为NULL，当某段代码尝试引用<code class="literal">typetup-&gt;typrelid</code>（或者更糟糕的是引用<code class="literal">typetup-&gt;typelem</code>，因为它跟随在<code class="structfield">typrelid</code>之后）时将会出现失败。这会导致随机错误乃至段错误。
  </p><p>
   作为对这类错误的一种部分保护，变长或可以为空的域不应该对C编译器可见。通过将它们包裹在<code class="literal">#ifdef CATALOG_VARLEN</code> ... <code class="literal">#endif</code>（其中<code class="literal">CATALOG_VARLEN</code>是一个永不被定义的符号）中可以实现这一点。这能防止C代码不小心尝试访问可能不在那里或者可能在其他某个偏移位置的域。作为一种防止创建不正确行的措施，我们要求所有应该为非空的列在<code class="structname">pg_attribute</code>中也被标记为非空。如果目录列是定长的并且前面没有任何可以为空的列，bootstrap代码将自动把它标记为<code class="literal">NOT NULL</code>。在这一规则不适用的地方，可以根据需要使用<code class="literal">BKI_FORCE_NOT_NULL</code>和<code class="literal">BKI_FORCE_NULL</code>标注强制正确的标记。但是要注意的是，<code class="literal">NOT NULL</code>约束仅在执行器中被强制，而不会针对随机C代码产生的元组进行强制，因此在手工创建或者更新目录行时仍需谨慎。
  </p><p>
   前端代码不应该包括任何<code class="filename">pg_xxx.h</code>目录头文件，因为这些文件可能包含在后端之外无法编译的C代码（通常，这是因为这些文件还包含<code class="filename">src/backend/catalog/</code>文件中函数的声明）。不过，前端代码可以包括相应的<code class="filename">pg_xxx_d.h</code>头文件，它将包含OID <code class="literal">#define</code>以及任何其他可能要在客户端使用的数据。如果希望前端代码能看到目录头文件中的宏或者其他代码，可以在相应部分的周围写上<code class="literal">#ifdef EXPOSE_TO_CLIENT_CODE</code> ... <code class="literal">#endif</code>，这样会指示<code class="filename">genbki.pl</code>把相应的部分拷贝到<code class="filename">pg_xxx_d.h</code>头文件中。
  </p><p>
   少数目录是非常基础的，以至于它们无法用大部分目录采用的<acronym class="acronym">BKI</acronym> <code class="literal">create</code>命令来创建，因为那个命令需要在这些目录中写入信息来描述新的目录。这些目录被称为<em class="firstterm">bootstrap</em>目录，定义一个这样的目录需要一些额外的工作：开发者必须为它在<code class="structname">pg_class</code>和<code class="structname">pg_type</code>的预装载内容中手工准备合适的项，并且后续对该目录结构的更改将会更新那些项（bootstrap目录还需要<code class="structname">pg_attribute</code>中的预装载项，但是幸运地是现如今的<code class="filename">genbki.pl</code>会处理这些杂务）。如果可能，一定避免将新目录创建为bootstrap目录。
  </p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="bki.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="bki.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="system-catalog-initial-data.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">第 69 章 系统目录声明和初始内容 </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始页</a></td><td width="40%" align="right" valign="top"> 69.2. 系统目录初始数据</td></tr></table></div></body></html>